<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>6-ukers Turnus Kalkulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #FAF9F6;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
      max-width: 1200px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    input[type="date"], input[type="time"], input[type="number"] {
      width: 100px;
      padding: 4px;
    }
    input[type="checkbox"] {
      transform: scale(1.3);
      margin: 4px;
    }
    button {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    tfoot td {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>6-ukers Turnus Kalkulator</h1>
  
  <button onclick="calculateAll()">Kalkuler alle dager</button>
  
  <table>
    <thead>
      <tr>
        <th>Dag</th>
        <th>Startdato</th>
        <th>Starttid</th>
        <th>Sluttdato</th>
        <th>Sluttid</th>
        <th>Timelønn (kr/t)</th>
        <th>Helligdag?</th>
        <th>Lokalttog?</th>
        <th>Daglig lønn</th>
      </tr>
    </thead>
    <tbody id="turnusTableBody">
      <!-- Rader genereres automatisk av JS -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="8" style="text-align: right;">Total for alle dager:</td>
        <td><span id="grandTotal">0 kr</span></td>
      </tr>
    </tfoot>
  </table>

  <script>
    // Antall dager i turnusen (6 uker * 7 dager = 42)
    const NUM_DAYS = 42;

    // Opprett rader dynamisk ved innlasting
    document.addEventListener('DOMContentLoaded', () => {
      const tableBody = document.getElementById("turnusTableBody");
      let rows = "";
      for (let i = 1; i <= NUM_DAYS; i++) {
        rows += `
        <tr>
          <td>Dag ${i}</td>
          <td><input type="date" id="startDate_${i}"></td>
          <td><input type="time" id="startTime_${i}"></td>
          <td><input type="date" id="endDate_${i}"></td>
          <td><input type="time" id="endTime_${i}"></td>
          <td><input type="number" id="hourlyRate_${i}" value="616"></td>
          <td><input type="checkbox" id="holidayCheckbox_${i}"></td>
          <td><input type="checkbox" id="lokalttogCheckbox_${i}"></td>
          <td><span id="dayTotal_${i}">0 kr</span></td>
        </tr>`;
      }
      tableBody.innerHTML = rows;
    });

    // Hjelpefunksjon for å telle minutter innenfor bonusperiode
    function computeBonusMinutes(start, end, bonusCheck) {
      let bonusMinutes = 0;
      let current = new Date(start);
      while (current < end) {
        if (bonusCheck(current)) bonusMinutes++;
        current.setMinutes(current.getMinutes() + 1);
      }
      return bonusMinutes;
    }

    // Kveldstillegg: kl. 20:00 - 06:00
    function isNightBonusMinute(time) {
      const h = time.getHours();
      return (h >= 20 || h < 6);
    }

    // Helgetillegg: fredag etter 17, hele lørdag/søndag, mandag før 06
    function isWeekendBonusMinute(time) {
      const d = time.getDay(); // 0= søn, 1= man, ... 6= lør
      const h = time.getHours();
      return (
        (d === 5 && h >= 17) || // fredag etter 17
        d === 6 ||              // lørdag
        d === 0 ||              // søndag
        (d === 1 && h < 6)      // mandag før kl. 06
      );
    }

    // Beregn lønn for én dag (rad i tabellen)
    function calculateDay(i) {
      const startDateVal = document.getElementById(`startDate_${i}`).value;
      const startTimeVal = document.getElementById(`startTime_${i}`).value;
      const endDateVal   = document.getElementById(`endDate_${i}`).value;
      const endTimeVal   = document.getElementById(`endTime_${i}`).value;
      const baseRate     = parseFloat(document.getElementById(`hourlyRate_${i}`).value) || 0;
      const holidayActive   = document.getElementById(`holidayCheckbox_${i}`).checked;
      const lokalttogActive = document.getElementById(`lokalttogCheckbox_${i}`).checked;

      // Sjekk om alle felter er fylt ut
      if (!startDateVal || !startTimeVal || !endDateVal || !endTimeVal) return 0;

      // Lag Date-objekter
      const start = new Date(`${startDateVal}T${startTimeVal}`);
      const end   = new Date(`${endDateVal}T${endTimeVal}`);

      // Dersom slutt er før/lik start, gir vi 0
      if (end <= start) return 0;

      // Grunnlønn
      const diffMs = end - start;
      const hoursWorked = diffMs / (3600 * 1000);
      const baseEarnings = hoursWorked * baseRate;

      // Kveld/helg-beregning
      const nightMinutes   = computeBonusMinutes(start, end, isNightBonusMinute);
      const weekendMinutes = computeBonusMinutes(start, end, isWeekendBonusMinute);
      const nightBonusTotal   = (nightMinutes / 60) * 151.27;
      const weekendBonusTotal = (weekendMinutes / 60) * 151.27;

      // Helligdagstillegg
      let holidayBonusPay = 0;
      if (holidayActive) {
        // Sjekk kun periode 06-20
        const bonusStart = new Date(start);
        bonusStart.setHours(6, 0, 0, 0);
        const bonusEnd = new Date(start);
        bonusEnd.setHours(20, 0, 0, 0);

        if (start < bonusEnd && end > bonusStart) {
          const bonusStartTime = new Date(Math.max(start, bonusStart));
          const bonusEndTime   = new Date(Math.min(end, bonusEnd));
          // 10 min ekstra pr time
          const bonusHours = (bonusEndTime - bonusStartTime) / (3600 * 1000) * (10 / 60);
          holidayBonusPay = bonusHours * baseRate;
        }
      }

      // Lokalttog-tillegg (engangsbeløp)
      const lokalttogBonus = lokalttogActive ? 134.46 : 0;

      // Sum for dagen
      return baseEarnings + nightBonusTotal + weekendBonusTotal + holidayBonusPay + lokalttogBonus;
    }

    // Kjør beregning for alle dager (42) og oppdater tabellen + total
    function calculateAll() {
      let grandTotal = 0;
      for (let i = 1; i <= NUM_DAYS; i++) {
        const dayTotal = calculateDay(i);
        document.getElementById(`dayTotal_${i}`).textContent = dayTotal.toFixed(2) + " kr";
        grandTotal += dayTotal;
      }
      document.getElementById("grandTotal").textContent = grandTotal.toFixed(2) + " kr";
    }
  </script>
</body>
</html>
