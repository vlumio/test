<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>6-ukers Kalkulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #FAF9F6;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    table {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #eee;
    }
    input[type="time"],
    input[type="number"] {
      width: 80px;
      padding: 4px;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      margin: 5px;
    }
    button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    .disabled {
      background-color: #ccc !important;
    }
    tfoot td {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>6-ukers Turnus Kalkulator</h1>
  <p style="text-align:center; max-width:600px; margin:0 auto;">
    Fyll inn tidene (eller kryss av for fri) for 7 dager. Koden antar at denne 7-dagersperioden
    gjentas 6 ganger (totalt 42 dager). Kvelds-/helgetillegg, helligdagstillegg og lokalttogtillegg
    beregnes for én uke og multipliseres deretter med 6.
  </p>

  <table>
    <thead>
      <tr>
        <th>Dag nr.</th>
        <th>Fri?</th>
        <th>Starttid</th>
        <th>Sluttid</th>
        <th>Timelønn (kr/t)</th>
        <th>Helligdag?</th>
        <th>Lokalttog?</th>
        <th>Lønn (1 uke)</th>
        <th>Lønn (6 uker)</th>
      </tr>
    </thead>
    <tbody id="turnusBody">
      <!-- 7 rader genereres dynamisk av JS -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="8" style="text-align:right;">Sum for 6 uker:</td>
        <td id="grandTotal">0 kr</td>
      </tr>
    </tfoot>
  </table>

  <button onclick="calculateAll()">Beregn 6-ukers lønn</button>

  <script>
    /****************************************************
     *  KONSTANTER OG HJELPEFUNKSJONER FOR TILLEGG
     ****************************************************/

    // Kveldstillegg: kl. 20:00 - 06:00
    function isNightBonusMinute(dateTime) {
      const h = dateTime.getHours();
      return (h >= 20 || h < 6);
    }

    // Helgetillegg: fredag etter kl. 17, hele lørdag/søndag, mandag før kl. 06
    function isWeekendBonusMinute(dateTime) {
      // I JS er 0 = søndag, 1 = mandag, ..., 5 = fredag, 6 = lørdag
      const day = dateTime.getDay();
      const h   = dateTime.getHours();
      return (
        (day === 5 && h >= 17) ||  // fredag etter 17
        day === 6 ||               // lørdag
        day === 0 ||               // søndag
        (day === 1 && h < 6)       // mandag før kl. 06
      );
    }

    // Gå minutt-for-minutt mellom start og slutt, og tell
    // hvor mange minutter som kvalifiserer for bonusCheck (f.eks. isNightBonusMinute)
    function computeBonusMinutes(start, end, bonusCheck) {
      let bonusMinutes = 0;
      let current = new Date(start);
      while (current < end) {
        if (bonusCheck(current)) {
          bonusMinutes++;
        }
        current.setMinutes(current.getMinutes() + 1);
      }
      return bonusMinutes;
    }

    /****************************************************
     *  GENERER TABELLEN (7 RADER)
     ****************************************************/
    const tableBody = document.getElementById("turnusBody");
    const NUM_DAYS = 7;  // Fyller inn for én uke (mandag–søndag)
    for (let i = 1; i <= NUM_DAYS; i++) {
      // HTML for hver rad
      // dayX = dagens "ID" (1..7)
      // Fri, Starttid, Sluttid, Timelønn, Helligdag, Lokalttog, Lønn 1 uke, Lønn 6 uker
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>Dag ${i}</td>
        <td>
          <input type="checkbox" id="fri_${i}" />
        </td>
        <td>
          <input type="time" id="startTime_${i}" />
        </td>
        <td>
          <input type="time" id="endTime_${i}" />
        </td>
        <td>
          <input type="number" id="hourlyRate_${i}" value="616" style="width:60px;" />
        </td>
        <td>
          <input type="checkbox" id="holidayCheckbox_${i}" />
        </td>
        <td>
          <input type="checkbox" id="lokalttogCheckbox_${i}" />
        </td>
        <td>
          <span id="oneWeekWage_${i}">0 kr</span>
        </td>
        <td>
          <span id="sixWeeksWage_${i}">0 kr</span>
        </td>
      `;
      tableBody.appendChild(row);
    }

    /****************************************************
     *  DISABLE TID-FELT NÅR "FRI" ER KRYSSET AV
     ****************************************************/
    for (let i = 1; i <= NUM_DAYS; i++) {
      const friCheckbox   = document.getElementById(`fri_${i}`);
      const startTimeInput= document.getElementById(`startTime_${i}`);
      const endTimeInput  = document.getElementById(`endTime_${i}`);

      // Når man krysser av/avkrysser "Fri", endres tilstanden på tidfeltene
      friCheckbox.addEventListener("change", () => {
        if (friCheckbox.checked) {
          startTimeInput.disabled = true;
          endTimeInput.disabled   = true;
          startTimeInput.classList.add("disabled");
          endTimeInput.classList.add("disabled");
        } else {
          startTimeInput.disabled = false;
          endTimeInput.disabled   = false;
          startTimeInput.classList.remove("disabled");
          endTimeInput.classList.remove("disabled");
        }
      });
    }

    /****************************************************
     *  BEREGN LØNN FOR EN ENKELT DAG (ÉN GANG)
     ****************************************************/
    function calculateDayOnce(dayIndex) {
      // Hvis "fri" er krysset, blir lønn 0
      const fri = document.getElementById(`fri_${dayIndex}`).checked;
      if (fri) return 0;

      // Hent start/slutt
      const startTimeVal = document.getElementById(`startTime_${dayIndex}`).value;
      const endTimeVal   = document.getElementById(`endTime_${dayIndex}`).value;
      const baseRate     = parseFloat(document.getElementById(`hourlyRate_${dayIndex}`).value) || 0;
      const holidayActive   = document.getElementById(`holidayCheckbox_${dayIndex}`).checked;
      const lokalttogActive = document.getElementById(`lokalttogCheckbox_${dayIndex}`).checked;

      // Hvis manglende start/sluttid, avbryt
      if (!startTimeVal || !endTimeVal) return 0;

      // Eksempel: Dag 1 = Mandag 6. jan 2025, Dag 2 = Tirsdag 7. jan, ... Dag i => 6. jan + (i-1) dager
      const baseDate = new Date(2025, 0, 6 + (dayIndex - 1)); // 6. jan 2025 er en mandag
      const [startH, startM] = startTimeVal.split(":").map(Number);
      const [endH, endM]     = endTimeVal.split(":").map(Number);

      // Bygg start- og sluttidspunkter
      const start = new Date(baseDate);
      start.setHours(startH, startM, 0, 0);

      const end   = new Date(baseDate);
      end.setHours(endH, endM, 0, 0);

      // Hvis slutt <= start, antar vi at vakten går over midnatt
      if (end <= start) {
        end.setDate(end.getDate() + 1);
      }

      // 1) Grunnlønn
      const diffMs = end - start;
      const hoursWorked = diffMs / (3600 * 1000);
      const baseEarnings = hoursWorked * baseRate;

      // 2) Kvelds- og helgetillegg
      const nightMinutes   = computeBonusMinutes(start, end, isNightBonusMinute);
      const weekendMinutes = computeBonusMinutes(start, end, isWeekendBonusMinute);
      const nightBonus     = (nightMinutes / 60) * 151.27;
      const weekendBonus   = (weekendMinutes / 60) * 151.27;

      // 3) Helligdagstillegg (ekstra 10 min per time i tidsrommet 06–20)
      let holidayBonusPay = 0;
      if (holidayActive) {
        const bonusStart = new Date(start);
        bonusStart.setHours(6,0,0,0);
        const bonusEnd = new Date(start);
        bonusEnd.setHours(20,0,0,0);

        if (start < bonusEnd && end > bonusStart) {
          const bonusStartTime = new Date(Math.max(start, bonusStart));
          const bonusEndTime   = new Date(Math.min(end, bonusEnd));
          // 10 ekstra min pr. faktisk time mellom 06 og 20
          const bonusHours = (bonusEndTime - bonusStartTime) / (3600 * 1000) * (10/60);
          holidayBonusPay = bonusHours * baseRate;
        }
      }

      // 4) Lokalttogtillegg (engangsbeløp)
      const lokalttogBonus = lokalttogActive ? 134.46 : 0;

      // Total lønn for denne dagen (én gang)
      return baseEarnings + nightBonus + weekendBonus + holidayBonusPay + lokalttogBonus;
    }

    /****************************************************
     *  BEREGN ALLE 7 DAGER OG VIS RESULTATER
     ****************************************************/
    function calculateAll() {
      let grandTotal = 0;  // Summerer alt for 6 uker
      for (let i = 1; i <= NUM_DAYS; i++) {
        // Lønn for én dag (én uke)
        const dayOnceWage = calculateDayOnce(i);

        // Ganger med 6 (6 uker)
        const daySixWage  = dayOnceWage * 6;

        // Oppdater tabellceller
        document.getElementById(`oneWeekWage_${i}`).textContent  = dayOnceWage.toFixed(2) + " kr";
        document.getElementById(`sixWeeksWage_${i}`).textContent = daySixWage.toFixed(2) + " kr";

        grandTotal += daySixWage;
      }

      // Oppdater total for 6 uker
      document.getElementById("grandTotal").textContent = grandTotal.toFixed(2) + " kr";
    }
  </script>
</body>
</html>
